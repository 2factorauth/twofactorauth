name: Publish Docker image
on:
  push:
    branches:
      - master
    paths:
      - ./Gemfile
      - ./Dockerfile
      - ./scripts/entrypoint.sh
jobs:
  - uses: actions/checkout@v2
  - uses: crazy-max/ghaction-docker-buildx@v3
    with:
      buildx-version: latest
      qemu-version: latest
  - name: Docker build
    run: |
      echo "${{ secrets.DOCKER_PASSWORD }}" | docker login --username ${{ secrets.DOCKER_USERNAME }} --password-stdin
      docker buildx create --use
      docker buildx build --platform linux/amd64,linux/arm/v7,linux/arm64 --rm --tag 2factorauth/twofactorauth:latest --push --compress .
